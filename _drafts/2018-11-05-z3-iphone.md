---
date: 2018-11-05T09:00:00-08:00
title: "SMT Solving on an iPhone"
excerpt: Why buy an expensive desktop computer when your iPhone is a faster SMT solver?
---

A few days ago, I tweeted this:

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">fun experiment: my new iPhone runs Z3 faster than my (rather expensive) Intel desktop!<br><br>time to start doing all my formal methods research on my phone <a href="https://t.co/9Faz9qNvAI">pic.twitter.com/9Faz9qNvAI</a></p>&mdash; James Bornholt (@siderealed) <a href="https://twitter.com/siderealed/status/1057682481334218752?ref_src=twsrc%5Etfw">October 31, 2018</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

I've been seeing discussion for a while about the incredible progress
[Apple's processor design team][bb1] is making,
and how it won't be too long until [Macs use Apple's own ARM processors][bb2].
These reports usually cite some cross-platform benchmarks
like [Geekbench][] to show that Apple's mobile processors
are at least as fast as Intel's laptop and desktop chips.
But I've always been a little skeptical
of these cross-platform benchmarks
(as are [others][linus])---do they really represent
the sorts of workloads I use my Macs for?

As a formal methods researcher,
the only real compute-intensive workload I run regularly
is SMT solving, usually the [Z3 SMT solver][z3].
At this point I've spent a lot of time
learning about Z3's performance characteristics,
and it also has some peculiarities benchmark suites won't capture
(Z3 is generally single threaded).
I recently bought a new [iPhone XS][]
featuring Apple's latest [A12][] processor.
So, in a fit of procrastination,
I decided to cross-compile Z3 to iOS,
and see just how fast my new phone (or hypothetical future Mac) is.

## The first test

Cross-compiling Z3 turns out to be remarkably simple,
with just a few lines of code changes necessary;
I open sourced the code to [run Z3 on your own iOS device][gh].
For benchmarks, I drew a few queries
from my recent work on [profiling symbolic evaluation][sympro],
extracting the SMT generated by [Rosette][] in each case.

As a first test, I compared my iPhone XS
to one of my desktop machines, which uses an Intel Core i7-7700K---the best
consumer desktop chip Intel was selling when we built the machine 18 months ago.
I expected the Intel chip to win quite handily here,
but that's not how things turned out:

{% include vega.html data="img/post/z3-iphone/initial.js" name="z3_initial" alt="img/post/z3-iphone/initial.png" %}

The iPhone XS was about 11% faster on this 23 second benchmark!
This is the result I tweeted about,
but Twitter doesn't leave much room for nuance,
so I'll add some here:

- This benchmark is in the `QF_BV` fragment of SMT,
  so Z3 discharges it using bit-blasting and SAT solving.
- This result holds up pretty well
  even if the benchmark runs in a loop 10 times---the iPhone
  can sustain this performance and doesn't seem thermally limited.[^water]
  That said, the benchmark is still pretty short.
- Several folks asked me if this is down to non-determinism---perhaps
  the solver takes different paths on the different platforms,
  due to use of random numbers or otherwise---but I checked
  fairly thoroughly using Z3's verbose output and that doesn't seem to be the case.
- Both systems ran Z3 4.8.1, compiled by me using Clang with the same
  optimization settings.
  I also tested on the i7-7700K using Z3's prebuilt binaries (which use GCC),
  but those were actually slower.


### What's going on?

How could this be possible?
The i7-7700K is a desktop CPU drawing at least 45 watts of power
and clocked at 4.5 GHz
when running a single-threaded workload;
in contrast, the iPhone was unplugged, probably doesn't draw 10% of that power,
and runs (we believe) somewhere in the 2 GHz range.
Indeed, after benchmarking I checked the iPhone's battery usage report,
which said Slack had used 4 times more energy than the Z3 app
despite less time on screen.

Apple doesn't expose enough information to understand Z3's performance on the iPhone,
but luckily, Intel does for their desktop processor.
I spent some time poking around using [VTune][]
to see where the bottlenecks were when running Z3 on the desktop.
As [Mate Soos][ms] observes,
most SAT solving time is [spent in propagation][ms1],
which is [very cache-sensitive][ms2].
VTune agrees, and says that Z3 spends a lot of time
waiting on memory
while iterating through watched literals.
So the key to performance here seems to be
cache size and memory latency.
This effect might explain why the iPhone is so strong on this benchmark---the A12 chip
has [a gigantic, low latency L2 cache][anand],
and also seems to have better memory latency after a cache miss compared to the 7700K.


## The rapid march of Apple silicon

To test whether that diagnosis is correct,
I ran a broader experiment,
gathering all the Apple devices I could get my hands on.
I also chose a benchmark about 10 times slower (i.e., 4 minutes on a desktop)
to mitigate any concerns about mobile burst performance.

Here are the results for the devices I gathered,
graphed according to their release date,
and relative to the Apple A7,
which was their first in-house CPU design:

{% include vega.html data="img/post/z3-iphone/sweep.js" name="z3_sweep" alt="img/post/z3-iphone/sweep.png" noload=true %}

The first thing to note is that the i7-7700K desktop processor
beats the iPhone XS on this different, longer benchmark.
But the iPhone is incredibly competitive, falling in between
the 7700K and its predecessor i7-6700K,
which was the fastest consumer desktop processor until just under two years ago.

For fun, I also added the Intel Core m7-6Y75,
which is the processor in my 2016 MacBook.
The iPhone XS is about 50% faster than my laptop at running Z3.

The really remarkable thing here is the trend for Apple: a fairly
consistency 30% year-on-year improvement for this Z3 benchmark.
Obviously we shouldn't draw too many conclusions from this one silly benchmark,
but it seems like it will only take one or two more iterations of this trend
for Apple CPUs to make total sense for my workloads.[^ipad]
I honestly didn't expect it to be this close---modern smartphone architectures
are incredible!

*Thanks to [Meghan Cowan][], [Max Willsey][], and [Eddie Yan][] for helping me track down more devices and run experiments.*

[^water]: [Max](https://mwillsey.com) pointed out that the iPhone is waterproof, so I could test this theory by dunking it in an ice bath, but I paid a lot of money for my phone and he won't volunteer his.
[^ipad]: I bet the new [iPad Pro](https://www.apple.com/ipad-pro/)'s A12X is even faster thanks to the larger thermal envelope a tablet affords.

[bb1]: https://www.bloomberg.com/graphics/2018-apple-custom-chips/
[bb2]: https://www.bloomberg.com/news/articles/2018-04-02/apple-is-said-to-plan-move-from-intel-to-own-mac-chips-from-2020/
[geekbench]: https://www.geekbench.com/
[linus]: https://www.realworldtech.com/forum/?threadid=136526&curpostid=136666
[z3]: https://github.com/z3prover/z3
[iPhone XS]: https://www.apple.com/iphone-xs/
[A12]: https://en.wikipedia.org/wiki/Apple_A12
[gh]: https://github.com/jamesbornholt/z3-ios
[sympro]: https://unsat.cs.washington.edu/projects/sympro
[rosette]: https://emina.github.io/rosette
[vtune]: https://software.intel.com/en-us/vtune
[ms]: https://www.msoos.org/
[ms1]: https://www.msoos.org/2010/07/propagating-faster/
[ms2]: https://www.msoos.org/2010/04/optimisations/
[anand]: https://www.anandtech.com/show/13392/the-iphone-xs-xs-max-review-unveiling-the-silicon-secrets/3
[Meghan Cowan]: https://cowanmeg.github.io/
[Max Willsey]: https://mwillsey.com/
[Eddie Yan]: https://homes.cs.washington.edu/~eqy/